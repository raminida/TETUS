<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎåÄÏãúÎ≥¥Îìú</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* US Open Dark Theme (Blue) */
            --bg-color: #121212;
            --surface-color: #1E1E1E;
            --primary-color: #3399FF; /* Brighter Blue for Dark Mode */
            --primary-variant-color: #66B2FF;
            --secondary-color: #FFFFFF;
            --text-color: #E0E0E0;
            --text-secondary-color: #A0A0A0;
            --accent-gold: #FFC107; /* Tennis ball yellow */
            --border-color: #333333;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 20px;
            --radius: 8px;
        }
        html[data-theme="light"] {
            /* US Open Light Theme (Blue) */
            --bg-color: #F0F4F8;
            --surface-color: #FFFFFF;
            --primary-color: #0055A5; /* Official US Open Blue */
            --primary-variant-color: #007BFF;
            --text-color: #1F2937;
            --text-secondary-color: #6B7280;
            --border-color: #E5E7EB;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 960px;
            margin: auto;
        }
        h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.8rem;
            text-align: center;
            color: transparent;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-variant-color));
            -webkit-background-clip: text;
            background-clip: text;
            padding: 20px 0;
            margin-bottom: 3rem;
        }
        .section {
            background: var(--surface-color);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px var(--shadow-color);
            margin-bottom: 3rem;
            border: 1px solid var(--border-color);
        }
        h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }
        .awards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .award-card {
            background: rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        html[data-theme="light"] .award-card {
            background: #F9FAFB;
        }
        .award-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            color: var(--accent-gold);
        }
        .award-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.3rem;
            color: var(--primary-variant-color);
            margin-bottom: 5px;
        }
        .award-winner {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-color);
        }
        .award-value {
            font-size: 0.9rem;
            color: var(--text-secondary-color);
        }
        .award-runner-up {
            font-size: 0.9rem;
            color: var(--text-secondary-color);
            margin-top: 5px;
        }
        .btn {
            display: inline-block;
            padding: 12px 28px;
            margin: 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-variant-color));
            color: #FFF;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 700;
        }
        html[data-theme="dark"] .btn {
            color: var(--bg-color);
        }
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #333, #111);
            color: #fff;
            padding: 12px 25px;
            border-radius: 50px;
            box-shadow: 0 5px 15px var(--shadow-color);
            opacity: 0;
            transition: opacity 0.4s;
            font-weight: 700;
        }
        html[data-theme="light"] .toast {
            background: linear-gradient(135deg, #f9f9f9, #f1f1f1);
            color: #333;
        }
        .toast.show {
            opacity: 1;
        }
        @media (max-width: 640px) {
            body { padding: 10px; }
            h1 { font-size: 2.2rem; }
            h2 { font-size: 1.8rem; }
            .section { padding: 20px; }
            .awards-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="theme-toggle">‚òÄÔ∏è</button>
    <div class="container">
        <h1>ÎåÄÏãúÎ≥¥Îìú</h1>
        
        <div class="section">
            <h2>üèÜ ÏãúÏ¶å Ïñ¥ÏõåÎìú</h2>
            <div class="awards-grid">
                </div>
            <div style="text-align:center;margin-top:30px">
                <a href="index.html" class="btn">Î©îÏù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</a>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // tetus-c91f0 ÏÑ§Ï†ï
        const firebaseConfig = {
            apiKey: "AIzaSyCj33GM2pM2-Vz1Fmh6eyMwQkWjByA7xdw",
            authDomain: "tetus-c91f0.firebaseapp.com",
            projectId: "tetus-c91f0",
            storageBucket: "tetus-c91f0.firebasestorage.app",
            messagingSenderId: "877913022272",
            appId: "1:877913022272:web:ec685d63235c87c3c1e4a5",
            measurementId: "G-7FJY9EKPV5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allPlayersData = [], matchesData = [], awardsData = {};

        const normalizePlayerName = name => name ? name.replace(/[@.*]+/g, '').trim().toLowerCase() : '';
        const totalGames = player => parseInt(player.wins || 0) + parseInt(player.losses || 0);

        const showToast = (msg, duration = 3000) => {
            const toast = document.getElementById('toast');
            if (!toast) {
                console.error('Toast ÏöîÏÜå ÏóÜÏùå');
                return;
            }
            if (toast.classList.contains('show')) return;
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        };

        const applyTheme = theme => {
            const validTheme = theme === 'light' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', validTheme);
            document.getElementById('theme-toggle').textContent = validTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', validTheme);
        };
        
        // Î¨∏ÏûêÏó¥ÏóêÏÑú Ïà´Ïûê(ÏäπÏàò) ÌååÏã±
        const parseWins = (str) => {
            const match = (str || '').match(/\((\d+)Ïäπ\)/);
            return match ? parseInt(match[1]) : 0;
        };

        const loadDashboard = async () => {
            try {
                console.log("loadDashboard ÏãúÏûë");
                
                const urlParams = new URLSearchParams(window.location.search);
                const seasonVersion = urlParams.get('season') || 'v2'; // URLÏóêÏÑú ÏãúÏ¶å Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                console.log(`ÏãúÏ¶å ${seasonVersion} Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...`);

                // FirebaseÏóêÏÑú Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const rankingDoc = await getDoc(doc(db, 'league', 'data', 'rankings', seasonVersion));
                if (rankingDoc.exists()) {
                    allPlayersData = rankingDoc.data().players || [];
                } else {
                    console.warn("Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå, Í∏∞Î≥∏ ÏÑ†ÏàòÎ°ú Ï¥àÍ∏∞Ìôî");
                    showToast("Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!");
                    allPlayersData = [{ name: "Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå", mmr: 1500, wins: 0, losses: 0, gameDiff: 0, totalSets: 0, isFemale: false, championships: 0, bagelWins: "0%(0Ïäπ)", bagelLosses: "0%(0Ìå®)" }];
                }
                
                allPlayersData = allPlayersData.map(p => ({
                    ...p,
                    gender: p.isFemale ? 'F' : 'M'
                }));
                console.log("Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞:", allPlayersData.length, "Î™Ö");

                // FirebaseÏóêÏÑú Ïä§ÏºÄÏ§Ñ(Îß§Ïπò) Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const scheduleDoc = await getDoc(doc(db, 'league', 'data', 'schedule', seasonVersion));
                if (scheduleDoc.exists()) {
                    matchesData = (scheduleDoc.data().matches || []).map((match, index) => {
                        const [score1, score2] = (match.score || '0-0').split('-').map(Number);
                        const isTeam1Winner = score1 > score2;
                        return {
                            ...match,
                            id: `${match.round}-${index}`,
                            winnerPlayer1: isTeam1Winner ? match.players[0] : match.players[2],
                            winnerPlayer2: isTeam1Winner ? match.players[1] : match.players[3],
                            loserPlayer1: isTeam1Winner ? match.players[2] : match.players[0],
                            loserPlayer2: isTeam1Winner ? match.players[3] : match.players[1],
                            gameDiff: Math.abs(score1 - score2),
                            createdAt: match.timestamp || new Date().toISOString()
                        }
                    });
                }
                console.log("Îß§Ïπò Îç∞Ïù¥ÌÑ∞:", matchesData.length, "Í≤ΩÍ∏∞");

                // Ïñ¥ÏõåÎìú Í≥ÑÏÇ∞
                const playedPlayers = allPlayersData.filter(p => totalGames(p) >= 0);
                if (playedPlayers.length) {
                    const getRank = (p, stat) => [...playedPlayers].sort((a, b) => (b[stat] || 0) - (a[stat] || 0)).findIndex(pl => pl.name === p.name) + 1;
                    const getPercentileScore = rank => playedPlayers.length <= 1 ? 100 : Math.pow((playedPlayers.length - rank) / (playedPlayers.length - 1), 0.7) * 100;

                    let mvpMalePlayer = null, maxMvpMaleScore = -Infinity, mvpMaleRunnerUp = null, secondMvpMaleScore = -Infinity;
                    let mvpFemalePlayer = null, maxMvpFemaleScore = -Infinity, mvpFemaleRunnerUp = null, secondMvpFemaleScore = -Infinity;
                    let bagelKingPlayer = null, maxBagelWins = -Infinity, bagelKingRunnerUp = null, secondBagelWins = -Infinity;
                    let winKingPlayer = null, maxWinDiff = -Infinity, winKingRunnerUp = null, secondWinDiff = -Infinity;

                    playedPlayers.forEach(player => {
                        const totalGamesPlayed = totalGames(player);
                        const gameCountBonus = Math.min(1.05, 1 + totalGamesPlayed * 0.002);

                        player.mmr = parseInt(player.mmr) || 1500;
                        player.wins = parseInt(player.wins) || 0;
                        player.losses = parseInt(player.losses) || 0;

                        const mmrRank = getRank(player, 'mmr');
                        const mmrScore = getPercentileScore(mmrRank) / 10;
                        player.winRate = totalGamesPlayed > 0 ? player.wins / totalGamesPlayed : 0;
                        const winRateRank = getRank(player, 'winRate');
                        const winRateScore = getPercentileScore(winRateRank) / 10;
                        player.normChampionships = parseInt(player.championships || 0);
                        const champRank = getRank(player, 'normChampionships');
                        const champScore = getPercentileScore(champRank) / 10;
                        
                        // Î≤†Ïù¥Í∏ÄÏäπÎ•†(%) -> (nÏäπ) ÌååÏã±
                        player.parsedBagelWins = parseWins(player.bagelWins);
                        const bagelRank = getRank(player, 'parsedBagelWins');
                        const bagelScore = getPercentileScore(bagelRank) / 10;
                        
                        player.gameDiffRate = totalGamesPlayed > 0 ? (parseFloat(player.avgGameDiff) || 0) : 0; // avgGameDiff ÏÇ¨Ïö©
                        const gameDiffRank = getRank(player, 'gameDiffRate');
                        const gameDiffScore = getPercentileScore(gameDiffRank) / 10;

                        let mvpScore = (mmrScore + winRateScore + champScore + bagelScore + 0.5 * gameDiffScore) / 4.5 * gameCountBonus;
                        mvpScore = mvpScore.toFixed(1);
                        if (player.gender === 'M') {
                            if (parseFloat(mvpScore) > maxMvpMaleScore) {
                                secondMvpMaleScore = maxMvpMaleScore; mvpMaleRunnerUp = mvpMalePlayer;
                                maxMvpMaleScore = parseFloat(mvpScore); mvpMalePlayer = { name: player.name, value: mvpScore };
                            } else if (parseFloat(mvpScore) > secondMvpMaleScore && parseFloat(mvpScore) < maxMvpMaleScore) {
                                secondMvpMaleScore = parseFloat(mvpScore); mvpMaleRunnerUp = { name: player.name, value: mvpScore };
                            }
                        } else if (player.gender === 'F') {
                            if (parseFloat(mvpScore) > maxMvpFemaleScore) {
                                secondMvpFemaleScore = maxMvpFemaleScore; mvpFemaleRunnerUp = mvpFemalePlayer;
                                maxMvpFemaleScore = parseFloat(mvpScore); mvpFemalePlayer = { name: player.name, value: mvpScore };
                            } else if (parseFloat(mvpScore) > secondMvpFemaleScore && parseFloat(mvpScore) < maxMvpFemaleScore) {
                                secondMvpFemaleScore = parseFloat(mvpScore); mvpFemaleRunnerUp = { name: player.name, value: mvpScore };
                            }
                        }

                        // Î≤†Ïù¥Í∏Ä ÌÇπ (Îã®Ïàú ÏäπÏàò Í∏∞Ï§Ä)
                        if (player.parsedBagelWins > maxBagelWins) {
                            secondBagelWins = maxBagelWins; bagelKingRunnerUp = bagelKingPlayer;
                            maxBagelWins = player.parsedBagelWins; bagelKingPlayer = { name: player.name, value: `${player.parsedBagelWins}Ïäπ` };
                        } else if (player.parsedBagelWins > secondBagelWins && player.parsedBagelWins < maxBagelWins) {
                            secondBagelWins = player.parsedBagelWins; bagelKingRunnerUp = { name: player.name, value: `${player.parsedBagelWins}Ïäπ` };
                        }
                        
                        // Îã§ÏäπÏôï
                        const winDiff = player.wins - player.losses;
                        if (totalGamesPlayed >= 1) {
                            const adjustedWinDiff = winDiff * gameCountBonus;
                            if (adjustedWinDiff > maxWinDiff) {
                                secondWinDiff = maxWinDiff; winKingRunnerUp = winKingPlayer;
                                maxWinDiff = adjustedWinDiff; winKingPlayer = { name: player.name, value: `${player.wins}Ïäπ ${player.losses}Ìå®` };
                            } else if (adjustedWinDiff > secondWinDiff && adjustedWinDiff < maxWinDiff) {
                                secondWinDiff = adjustedWinDiff; winKingRunnerUp = { name: player.name, value: `${player.wins}Ïäπ ${player.losses}Ìå®` };
                            }
                        }
                    });

                    awardsData = {
                        mvpMale: { winner: mvpMalePlayer || { name: '-', value: '-' }, runnerUp: mvpMaleRunnerUp || { name: '-', value: '-' } },
                        mvpFemale: { winner: mvpFemalePlayer || { name: '-', value: '-' }, runnerUp: mvpFemaleRunnerUp || { name: '-', value: '-' } },
                        winKing: { winner: winKingPlayer || { name: '-', value: '-' }, runnerUp: winKingRunnerUp || { name: '-', value: '-' } },
                        bagelKing: { winner: bagelKingPlayer || { name: '-', value: '-' }, runnerUp: bagelKingRunnerUp || { name: '-', value: '-' } }
                    };
                    
                    console.log("Ïñ¥ÏõåÎìú Îç∞Ïù¥ÌÑ∞:", Object.keys(awardsData).length, "Í∞ú");

                    const awardDetails = {
                        mvpMale: { title: "ÏãúÏ¶å MVP (ÎÇ®)", icon: "üëë", valuePrefix: "MVP Ï†êÏàò: " },
                        mvpFemale: { title: "ÏãúÏ¶å MVP (Ïó¨)", icon: "üëë", valuePrefix: "MVP Ï†êÏàò: " },
                        winKing: { title: "ÏãúÏ¶å Îã§ÏäπÏôï", icon: "üèÜ", valuePrefix: "" },
                        bagelKing: { title: "ÏãúÏ¶å Î≤†Ïù¥Í∏Ä ÌÇπ", icon: "ü•Ø", valuePrefix: "" }
                    };

                    const grid = document.querySelector('.awards-grid');
                    if (!grid) {
                        console.error("Ïñ¥ÏõåÎìú Í∑∏Î¶¨Îìú ÏöîÏÜå ÏóÜÏùå");
                        showToast("Ïñ¥ÏõåÎìú Í∑∏Î¶¨Îìú Ïò§Î•ò!");
                        return;
                    }
                    grid.innerHTML = '';
                    for (const key in awardDetails) {
                        const awardInfo = awardDetails[key];
                        const data = awardsData[key] || { winner: { name: '-', value: '-' }, runnerUp: { name: '-', value: '-' } };
                        console.log(`Ïñ¥ÏõåÎìú Î†åÎçîÎßÅ: ${key}, Îç∞Ïù¥ÌÑ∞:`, data);
                        const winner = data.winner?.name || data.name || '-';
                        const winnerValue = data.winner?.value || data.value || '-';
                        const runnerUp = data.runnerUp?.name || '-';
                        const runnerUpValue = data.runnerUp?.value || data.value || '-';
                        const card = document.createElement('div');
                        card.className = 'award-card';
                        console.log(`award-card HTML ÏÉùÏÑ±: ${key}`);
                        card.innerHTML = `
                            <div class="award-icon">${awardInfo.icon}</div>
                            <div class="award-title">${awardInfo.title}</div>
                            <div class="award-winner">${winner}${winner !== '-' ? (allPlayersData.find(p => p.name === winner)?.isFemale ? '*' : '') : ''}</div>
                            <div class="award-value">${awardInfo.valuePrefix}${winnerValue}</div>
                            <div class="award-runner-up">2ÏúÑ: ${runnerUp}${runnerUp !== '-' ? (allPlayersData.find(p => p.name === runnerUp)?.isFemale ? '*' : '') : ''} (${awardInfo.valuePrefix}${runnerUpValue})</div>
                        `;
                        grid.appendChild(card);
                    }
                }

                console.log("loadDashboard ÏôÑÎ£å");
            } catch (e) {
                console.error("loadDashboard Ï†ÑÏ≤¥ Ïã§Ìå®:", e.message);
                showToast("Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®! ÎÑ§Ìä∏ÏõåÌÅ¨ Î∞è Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏ÌïòÏÑ∏Ïöî.");
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOMContentLoaded Ïù¥Î≤§Ìä∏ Î∞úÏÉù, DOM Î°úÎìú ÏôÑÎ£å");
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
            
            try {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
                loadDashboard();
            } catch (error) {
                console.error("Anonymous sign-in failed:", error);
                showToast("DB Ïù∏Ï¶ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            }
            
            document.getElementById('theme-toggle').addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
        });
    </script>
</body>
</html>